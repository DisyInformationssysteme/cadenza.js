<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>Cadenza JS Development Sandbox</title>

  <style>
    :root {
      --bg: #eee;
      --gap: 12px;
      --padding: 16px;
    }
    * {
      box-sizing: border-box;
    }
    html, body {
      height: 100%;
    }
    body {
      display: grid;
      grid-template-areas:
        'aside  main'
        'footer footer';
      grid-template-columns: 368px 1fr;
      grid-template-rows: 1fr auto;
      margin: 0;
    }
    aside {
      background: var(--bg);
      grid-area: aside;
      overflow: hidden auto;
    }
    form {
      padding-inline: var(--padding);
    }
    form, fieldset {
      display: flex;
      flex-direction: column;
      gap: var(--gap);
    }
    fieldset > div {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    fieldset small {
      display: flex;
      flex-direction: column;
      gap: 4px;

      > * {
        margin-block: 0;
      }
    }
    .action-container {
      align-items: end;
      background: var(--bg);
      border-bottom: 2px solid gray;
      display: flex;
      gap: 4px;
      padding-bottom: var(--gap);
      padding-top: var(--padding);
      position: sticky;
      top: 0;

      > :first-child {
        flex: 1;
      }
    }
    #action:not(.show-unpublished) option.unpublished {
      display: none;
    }
    main {
      grid-area: main;
      padding: var(--padding);
    }
    iframe {
      border: 4px solid #eee;
      height: 100%;
      width: 100%;
    }
    label {
      font-weight: 600;
    }
    hr:first-child {
        display: none;
    }
    select, input:is(:not([type]), [type=text], [type=number]), textarea, hr {
      display: block;
      width: 100%
    }
    footer {
      background: var(--bg);
      display: flex;
      font-size: small;
      grid-area: footer;
      justify-content: space-between;
      padding: 4px var(--padding);

      > * {
        margin: 0;
      }
    }
  </style>

  <script type="module">
    import { cadenza } from './cadenza.js';

    const actionSelect = document.getElementById('action');
    const settingsContainer = document.getElementById('settings');
    actionSelect.onchange = () => {
      settingsContainer.innerHTML = '';
      const action = actionSelect.value;
      const settingsTemplate = document.querySelector(`[data-action=${action}]`);
      settingsContainer.append(settingsTemplate.content.cloneNode(true));
      if (settingsTemplate.dataset.common) {
        settingsTemplate.dataset.common.split(',').forEach(commonId => {
          const commonSettingsTemplate = document.getElementById(`common-${commonId}`);
          settingsContainer.append(
            document.createElement('hr'),
            commonSettingsTemplate.content.cloneNode(true));
        })
      }

      const data = localStorage.getItem(`cadenzajs-sandbox-${action}`);
      if (data) {
        applyData(JSON.parse(data));
      }

      const url = new URL(location.href);
      url.searchParams.set('action', action);
      history.replaceState(null, '', url);
    };

    const urlParams = new URLSearchParams(location.search);
    const parentMode = urlParams.has('parentMode');
    const contextPath = urlParams.get('contextPath')
      ?? location.pathname.slice(0, location.pathname.indexOf('/sandbox'));
    const cadenzaClient = cadenza({
      baseUrl: parentMode ? undefined : location.origin + contextPath,
      iframe: parentMode ? undefined : 'iframe',
      debug: true
    });
    const actionHandlers = {
      show: data => cadenzaClient.show(data.embeddingTargetId, getOptions(data)),
      showPage: data => cadenzaClient.show({ page: data.page }, getOptions(data)),
      showMap: data => cadenzaClient.showMap(data.embeddingTargetId, getOptions(data)),
      expandNavigator: data => cadenzaClient.expandNavigator(data.expandNavigator === 'on'),
      reload: data => cadenzaClient.reload({ invalidateCaches: data.invalidateCaches === 'on'}),
      closeMe: () => cadenzaClient.closeMe(),
      getData: async data => {
        const dataType = data.dataType;
        const result = await cadenzaClient.getData(dataType);
        if (dataType === 'png') {
          const url = URL.createObjectURL(result);
          iframe.src = url;
          URL.revokeObjectURL(url);
        }
      },
      setFilter: data => cadenzaClient.setFilter(parseFilterVariables(data.filter)),
      setLayerVisibility: data => cadenzaClient.setLayerVisibility(JSON.parse(data.layer), data.visibility === 'on'),
      setSelection: data => cadenzaClient.setSelection(JSON.parse(data.layer), JSON.parse(data.objectIds)),
      addSelection: data => cadenzaClient.addSelection(JSON.parse(data.layer), JSON.parse(data.objectIds)),
      removeSelection: data => cadenzaClient.removeSelection(JSON.parse(data.layer), JSON.parse(data.objectIds)),
      createGeometry: data => cadenzaClient.createGeometry(data.embeddingTargetId, data.geometryType, getOptions(data)),
      editGeometry: ({ geometry, ...data }) => cadenzaClient.editGeometry(data.embeddingTargetId, JSON.parse(geometry), getOptions(data)),
      selectObjects: data => cadenzaClient.selectObjects(data.embeddingTargetId, getOptions(data)),
      fetchData: data => {
        console.log('Inspect the fetchData() request in the devtools.');
        cadenzaClient.fetchData(data.embeddingTargetId, data.dataType, getOptions(data));
      },
      fetchObjectInfo: data => {
        console.log('Inspect the fetchObjectInfo() request in the devtools.');
        cadenzaClient.fetchObjectInfo(data.embeddingTargetId, JSON.parse(data.layer), JSON.parse(data.objectIds), getOptions(data))
          .then(console.log);
      },
      fetchAreaIntersections: data => {
        console.log('Inspect the fetchAreaIntersections() request in the devtools.');
        cadenzaClient.fetchAreaIntersections(data.embeddingTargetId, JSON.parse(data.layer), JSON.parse(data.geometry), getOptions(data))
          .then(console.log);
      },
      downloadData: data => cadenzaClient.downloadData(data.embeddingTargetId, data.dataType, getOptions(data)),
      setCustomValidity: data => cadenzaClient.setCustomValidity(data.message, data.type || undefined)
    };

    const form = document.getElementById('form');
    form.onsubmit = (event) => {
      event.preventDefault();
      const { action, ...data } = Object.fromEntries(new FormData(form));
      actionHandlers[action](data);
      localStorage.setItem(`cadenzajs-sandbox-${action}`, JSON.stringify(data));
    };

    actionSelect.classList.toggle('show-unpublished', urlParams.has('showUnpublished'))
    actionSelect.value = urlParams.get('action') || 'show';
    actionSelect.onchange();

    function applyData (data) {
      for (const [ name, value ] of Object.entries(data)) {
        const control = form.elements[name];
        if (control) {
          if (control.type === 'checkbox') {
            control.checked = (value === 'on');
          } else {
            control.value = value;
          }
        }
      }
    }

    function getOptions ({
      disabledUiFeatures,
      expandNavigator,
      fileName,
      filter,
      geometry,
      hideMainHeaderAndFooter,
      hideWorkbookToolBar,
      highlightGlobalId,
      jasperReportAsPdf,
      labelSet,
      locationFinder,
      mapExtent,
      minScale,
      parts,
      layers,
      simplifiedOperationMode,
      useMapSrs,
      fullGeometries,
      zoomToGeometry,
      distance,
      lengthUnit,
      additionalLayers
    }) {
      return {
        disabledUiFeatures: disabledUiFeatures && disabledUiFeatures.split(','),
        expandNavigator: (expandNavigator === 'on'),
        fileName,
        filter: filter && parseFilterVariables(filter),
        geometry: geometry && JSON.parse(geometry),
        hideMainHeaderAndFooter: (hideMainHeaderAndFooter === 'on'),
        hideWorkbookToolBar: (hideWorkbookToolBar === 'on'),
        highlightGlobalId,
        ...(jasperReportAsPdf === 'on' && { dataType: 'pdf' }),
        labelSet,
        locationFinder,
        mapExtent: mapExtent && mapExtent.split(',').map(Number),
        minScale: minScale && Number(minScale),
        parts: parts && parts.split(','),
        operationMode: (simplifiedOperationMode === 'on' ? 'simplified' : 'normal' ),
        layers: layers ? JSON.parse(layers) : undefined,
        useMapSrs: useMapSrs === 'on',
        fullGeometries: fullGeometries === 'on',
        zoomTarget: zoomToGeometry === 'on' ? { type: 'geometry' } : undefined,
        buffer: distance ? { value: Number(distance), lengthUnit: lengthUnit ? lengthUnit : 'm' } : undefined,
        additionalLayers: additionalLayers && JSON.parse(additionalLayers)
      };
    }

    function parseFilterVariables (filterString) {
      return JSON.parse(filterString.trim(), (_, value) => {
        if (value === '{{currentDate}}') { // convenience for current date
          return new Date();
        }
        if (value?.match?.(/....-..-..T..:..:..\....Z/)) {
          return new Date(value);
        }
        return value;
      });
    }
  </script>
</head>
<body>

<aside>
  <form id="form">
    <div class="action-container">
      <div>
        <label for="action">Action</label>
        <select name="action" id="action">
          <optgroup label="Show">
            <option value="show">Show</option>
            <option value="showPage">Show Page</option>
            <option value="showMap">Show Map</option>
          </optgroup>
          <optgroup label="Interact With Shown Content">
            <option value="expandNavigator">Expand Navigator</option>
            <option value="getData" class="unpublished">Get Data (Get Map Image)</option>
            <option value="setFilter" class="unpublished">Set Filter</option>
            <option value="setLayerVisibility" class="unpublished">Set Layer Visibility</option>
            <option value="setSelection" class="unpublished">Set Selection</option>
            <option value="addSelection" class="unpublished">Add Selection</option>
            <option value="removeSelection" class="unpublished">Remove Selection</option>
            <option value="reload">Reload worksheet views</option>
            <option value="closeMe">Close me</option>
          </optgroup>
          <optgroup label="Map Dialogs">
            <option value="createGeometry">Create Geometry</option>
            <option value="editGeometry">Edit Geometry</option>
            <option value="selectObjects">Select Objects</option>
            <option value="setCustomValidity">Set Custom Validity</option>
          </optgroup>
          <optgroup label="Without Iframe">
            <option value="downloadData">Download data</option>
            <option value="fetchData">Fetch data</option>
            <option value="fetchObjectInfo">Fetch Object Info</option>
            <option value="fetchAreaIntersections">Fetch Area Intersections</option>
          </optgroup>
        </select>
      </div>

      <button>Go!</button>
    </div>

    <fieldset id="settings"></fieldset>
  </form>
</aside>

<main>
  <iframe id="iframe"></iframe>
</main>

<footer>
  <a href="https://disyinformationssysteme.github.io/cadenza.js/" target="_blank" rel="noreferrer">Cadenza JS Documentation</a>
  <p>Open the browser's devtools (<kbd>F12</kbd>) to see requests and events.</p>
</footer>

<template id="common-show">
  <div>
    <label>
      <input type="checkbox" name="hideMainHeaderAndFooter">
      Hide main header and footer
    </label>
  </div>
  <div>
    <label for="highlightGlobalId">Highlighted Global ID</label>
    <input name="highlightGlobalId" id="highlightGlobalId">
  </div>
</template>

<template id="common-showWorkbook">
  <div>
    <label>
      <input type="checkbox" name="hideWorkbookToolBar">
      Hide workbook toolbar
    </label>
  </div>
  <div>
    <label>
      <input type="checkbox" name="simplifiedOperationMode">
      Simplified operation mode
    </label>
  </div>
  <div>
    <label for="disabledUiFeatures">Disabled UI features</label>
    <input name="disabledUiFeatures" id="disabledUiFeatures" placeholder="feature1,feature2,...">

    <small>
      <p>Comma-separated list of features</p>

      Supported features:
      <ul>
        <li>workbook-design</li>
        <li>workbook-view-management</li>
      </ul>
    </small>
  </div>
  <div>
    <label>
      <input type="checkbox" name="expandNavigator">
      Expand navigator tree
    </label>
  </div>
</template>

<template id="common-filter">
  <div>
    <label for="filter">Filter</label>
    <textarea name="filter" id="filter" rows="3"></textarea>
    <small>
      <p>A JSON object with filter variable names and values</p>
      <p>Dates need to be ISO strings<br>(e.g. <code>"2023-11-17T17:12:06.175Z"</code>).<br>Use <code>"{{currentDate}}"</code> for the current date.</p>
      <p>Pass multiple values for an <code>IN</code> expression as <code>["a", "b", ...]</code></p>
      <p>Pass <code>null</code> to unset a variable.</p>
    </small>
  </div>
</template>

<template id="common-map">
  <div>
    <label>
      <input type="checkbox" name="useMapSrs">
      Use map SRS
    </label>
  </div>
  <div>
    <label for="mapExtent">Map extent coordinates</label>
    <input name="mapExtent" id="mapExtent" placeholder="minX,minY,maxX,maxY">
  </div>
  <div>
    <label for="locationFinder">Location finder search query</label>
    <input name="locationFinder" id="locationFinder">
  </div>
</template>

<template id="common-data">
  <div>
    <label for="dataType">Data type *</label>
    <select name="dataType" id="dataType" required>
      <option>csv</option>
      <option>excel</option>
      <option>json</option>
      <option>pdf</option>
    </select>
  </div>
  <div>
    <label for="parts">Parts</label>
    <input name="parts" id="parts" placeholder="columns,values,totals">
    <small>
      A comma-separated list of parts. Supported parts are:
      <ul>
        <li>columns</li>
        <li>values</li>
        <li>totals</li>
      </ul>
    </small>
  </div>
</template>

<template data-action="show" data-common="showWorkbook,filter,show">
  <div>
    <label for="embeddingTargetId">Embedding target ID *</label>
    <input name="embeddingTargetId" id="embeddingTargetId" required>
  </div>
  <div>
    <label>
      <input type="checkbox" name="jasperReportAsPdf" id="jasperReportAsPdf"/>
      Show Jasper Report as PDF
    </label>
  </div>
</template>

<template data-action="showPage" data-common="show">
  <div>
    <label for="page">Page *</label>
    <select name="page" id="page" required>
      <option>welcome</option>
      <option>an-invalid-page-name</option>
    </select>
  </div>
  <div>
    <label for="labelSet">Label Set</label>
    <input name="labelSet" id="labelSet">
  </div>
</template>

<template data-action="expandNavigator">
  <div>
    <label>
      <input type="checkbox" name="expandNavigator">
      Expand navigator tree
    </label>
  </div>
</template>

<template data-action="showMap" data-common="zoomTo,map,showWorkbook,filter,show">
  <div>
    <label for="embeddingTargetId">Embedding target ID of the map view *</label>
    <input name="embeddingTargetId" id="embeddingTargetId" required>
  </div>
  <div>
    <label for="geometry">Geometry (GeoJSON)</label>
    <textarea name="geometry" id="geometry" rows="5"></textarea>
  </div>
</template>

<template data-action="setCustomValidity">
  <p>Requires a geometry editing UI (Create / Edit Geometry actions) to be opened first.</p>
  <label for="message">Message</label>
  <input type="text" name="message" id="message">
  <label for="type">Type</label>
  <select name="type" id="type">
    <option selected></option>
    <option>success</option>
    <option>info</option>
    <option>warning</option>
    <option>error</option>
  </select>
</template>

<template data-action="setFilter" data-common="filter"></template>

<template data-action="createGeometry" data-common="map,filter">
  <div>
    <label for="embeddingTargetId">Embedding target ID of the map view *</label>
    <input name="embeddingTargetId" id="embeddingTargetId" required>
  </div>
  <div>
    <label for="geometry">Additional layers (GeoJSON)</label>
    <textarea name="additionalLayers" id="additionalLayers" rows="10"></textarea>
  </div>
  <div>
    <label for="geometryType">Geometry type</label>
    <select name="geometryType" id="geometryType">
      <option>Point</option>
      <option>MultiPoint</option>
      <option>LineString</option>
      <option>MultiLineString</option>
      <option>Polygon</option>
      <option>MultiPolygon</option>
    </select>
  </div>
  <div>
    <label>
      <input type="checkbox" name="simplifiedOperationMode">
      Simplified operation mode
    </label>
  </div>
  <div>
    <label for="minScale">Minimum Scale</label>
    <input type="number" name="minScale" id="minScale">
  </div>
</template>

<template data-action="editGeometry" data-common="zoomTo,map,filter">
  <div>
    <label for="embeddingTargetId">Embedding target ID of the map view *</label>
    <input name="embeddingTargetId" id="embeddingTargetId" required>
  </div>
  <div>
    <label for="geometry">Additional layers (GeoJSON)</label>
    <textarea name="additionalLayers" id="additionalLayers" rows="10"></textarea>
  </div>
  <div>
    <label for="geometry">Geometry (GeoJSON) *</label>
    <textarea name="geometry" id="geometry" rows="5" required></textarea>
  </div>
  <div>
    <label>
      <input type="checkbox" name="simplifiedOperationMode">
      Simplified operation mode
    </label>
  </div>
  <div>
    <label for="minScale">Minimum Scale</label>
    <input type="number" name="minScale" id="minScale">
  </div>
</template>

<template data-action="selectObjects" data-common="map,filter">
  <div>
    <label for="embeddingTargetId">Embedding target ID of the map view *</label>
    <input name="embeddingTargetId" id="embeddingTargetId" required>
  </div>
  <div>
    <label>
      <input type="checkbox" name="simplifiedOperationMode">
      Simplified operation mode
    </label>
  </div>
  <div>
    <label for="layers">Layers</label>
    <input name="layers" id="layers">
    <small>
      <p>
        A JSON value like <code>["&lt;layerPrintName&gt;",...]</code> or
        <code>[["&lt;layerGroupPrintName&gt;","&lt;layerPrintName&gt;"],...]</code>
      </p>
    </small>
  </div>
</template>

<template data-action="setLayerVisibility" data-common="layer">
  <div>
    <label>
      <input type="checkbox" name="visibility">
      Visible
    </label>
  </div>
</template>

<template data-action="setSelection" data-common="layer,object-ids"></template>
<template data-action="addSelection" data-common="layer,object-ids"></template>
<template data-action="removeSelection" data-common="layer,object-ids"></template>

<template data-action="reload">
  <div>
    <label>
      <input type="checkbox" name="invalidateCaches">
      Invalidate caches
    </label>
  </div>
</template>
<template data-action="closeMe">No Parameters needed.</template>

<template id="common-object-ids">
  <div>
    <label for="objectids">List of object ID value lists *</label>
    <textarea name="objectIds" id="objectids" rows="5" required></textarea>
    <small>
      <p>A JSON value like <code>[["&lt;object1-id&gt;"],["&lt;object2-id&gt;"]]</code></p>
    </small>
  </div>
</template>

<template id="common-layer">
  <div>
    <label for="layer">Layer *</label>
    <input name="layer" id="layer" required>
    <small>
      <p>
        A JSON value like <code>"&lt;layerPrintName&gt;"</code> or
        <code>["&lt;layerGroupPrintName&gt;","&lt;layerPrintName&gt;"]</code>
      </p>
    </small>
  </div>
</template>

<template id="common-zoomTo">
  <div>
    <label>
      <input type="checkbox" name="zoomToGeometry">
      Zoom to geometry
    </label>
  </div>
</template>

<template data-action="downloadData" data-common="data,filter">
  <div>
    <label for="embeddingTargetId">Embedding target ID *</label>
    <input name="embeddingTargetId" id="embeddingTargetId" required>
  </div>
  <div>
    <label for="fileName">Filename</label>
    <input name="fileName" id="fileName">
  </div>
</template>

<template data-action="fetchData" data-common="data,filter">
  <div>
    <label for="embeddingTargetId">Embedding target ID *</label>
    <input name="embeddingTargetId" id="embeddingTargetId" required>
  </div>
</template>

<template data-action="fetchObjectInfo" data-common="layer,object-ids,filter">
  <div>
    <label for="embeddingTargetId">Embedding target ID *</label>
    <input name="embeddingTargetId" id="embeddingTargetId" required>
  </div>
  <div>
    <label>
      <input type="checkbox" name="useMapSrs">
      Use map SRS
    </label>
  </div>
  <div>
    <label>
      <input type="checkbox" name="fullGeometries">
      Return the non-simplified geometries
    </label>
  </div>
</template>

<template data-action="fetchAreaIntersections" data-common="layer">
  <div>
    <label for="embeddingTargetId">Embedding target ID *</label>
    <input name="embeddingTargetId" id="embeddingTargetId" required>
  </div>
  <div>
    <label for="geometry">Intersection Geometry (GeoJSON) *</label>
    <textarea name="geometry" id="geometry" rows="5" required></textarea>
    <small>
      <p>
        The geometry must result in an area in combination with the buffer specification.
      </p>
    </small>
  </div>
  <div>
    <label>
      <input type="checkbox" name="useMapSrs">
      Use map SRS
    </label>
  </div>
  <div>
    <label for="distance">Buffer size</label>
    <input name="distance" id="distance" type="number" min="0">
    <label for="lengthUnit">Length unit</label>
    <select name="lengthUnit" id="lengthUnit">
      <option>m</option>
      <option>km</option>
    </select>
    <small>
      <p>
        A positive buffer size is needed for point or line intersection geometries.
      </p>
    </small>
  </div>
</template>

<template data-action="getData">
  <div>
    <label for="dataType">Data type</label>
    <select name="dataType" id="dataType" disabled>
      <option>png</option>
    </select>
    <input type="hidden" name="dataType" value="png">
    <small>
      <p>Currently, only <code>dataType=png</code> is supported to get the image of the currently shown workbook map view.</p>
    </small>
  </div>
</template>

</body>
</html>
